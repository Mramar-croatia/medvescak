<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Istraživanje povijesnog vodotoka u Zagrebu</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fff;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px;
            z-index: 1;
            cursor: crosshair;
            background: #f5f5f5;
        }

        #map .map-error {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 16px;
            color: #444;
            font-size: 14px;
            background: #f5f5f5;
        }

        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            z-index: 1000;
        }

        #instruction {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
        }

        .btn-row {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 320px;
        }

        button {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.15s, background-color 0.15s;
        }

        button:active { opacity: 0.8; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        #btn-clear {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        #btn-submit {
            background: #2c3e50;
            color: #fff;
        }

        #status {
            position: absolute;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            z-index: 1001;
            display: none;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #overlay h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        #overlay p {
            font-size: 14px;
            color: #666;
        }

        .leaflet-control-attribution {
            font-size: 10px !important;
        }

        /* Loading spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #data-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            gap: 8px;
            z-index: 1000;
        }

        #data-controls button {
            flex: 0;
            width: 34px;
            height: 34px;
            padding: 0;
            border-radius: 6px;
            background: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
            font-size: 0;
            line-height: 0;
        }

        #data-controls button svg {
            width: 18px;
            height: 18px;
            fill: #2c3e50;
        }

        #data-controls button.is-active {
            background: #2c3e50;
        }

        #data-controls button.is-active svg {
            fill: #fff;
        }

        #welcome-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        #welcome-modal.is-hidden {
            display: none;
        }

        #welcome-modal .modal-content {
            position: relative;
            background: #fff;
            color: #2c3e50;
            padding: 28px 40px 20px;
            border-radius: 8px;
            width: min(320px, 85vw);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            font-size: 14px;
            line-height: 1.4;
            text-align: center;
        }

        #welcome-modal .modal-close {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: #f5f5f5;
            color: #555;
            font-size: 18px;
            line-height: 28px;
            cursor: pointer;
        }

        /* Point count indicator */
        #point-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="welcome-modal" class="is-hidden" role="dialog" aria-modal="true" aria-labelledby="welcome-title">
        <div class="modal-content">
            <button id="btn-close-welcome" class="modal-close" type="button" aria-label="Zatvori">×</button>
            <p id="welcome-title">Ucrtaj sto preciznije gdje mislis da je tekao potok Medvescak.</p>
        </div>
    </div>

    <div id="data-controls">
        <button id="btn-open-sheet" type="button" title="Otvori tablicu s odgovorima" aria-label="Otvori tablicu s odgovorima">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1zm7 1.5V9h4.5L14 4.5zM8 12h8v2H8v-2zm0 4h8v2H8v-2z"/>
            </svg>
        </button>
        <button id="btn-toggle-responses" type="button" title="Prikaži odgovore" aria-label="Prikaži odgovore">
            <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 5c4.5 0 8.4 2.6 10 6.5-1.6 3.9-5.5 6.5-10 6.5S3.6 15.4 2 11.5C3.6 7.6 7.5 5 12 5zm0 2c-3.2 0-6 1.7-7.6 4.5C6 14.3 8.8 16 12 16s6-1.7 7.6-4.5C18 8.7 15.2 7 12 7zm0 2.5A2.5 2.5 0 1 1 9.5 12 2.5 2.5 0 0 1 12 9.5z"/>
            </svg>
        </button>
    </div>

    <div id="point-count">Točke: <span id="count">0</span></div>

    <div id="status"></div>

    <div id="controls">
        <p id="instruction">Nacrtajte liniju na karti gdje mislite da je tekao vodotok.</p>
        <div class="btn-row">
            <button id="btn-clear" type="button">Očisti</button>
            <button id="btn-submit" type="button">Pošalji</button>
        </div>
    </div>

    <div id="overlay">
        <h2>Hvala</h2>
        <p>Vaš odgovor je zabilježen.</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxb68dmmMr2VBem50I7uj58hEfFOV3TMohDDWTtwhNKEA83pEznL7X6vItO7gwb4QsfJw/exec";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/1p9stWgA7yF2eZ4u2Rom169E4k-CxwIJ4je_T2NAgFoY/edit?gid=182911410#gid=182911410";
        
        // ZAGREB COORDINATES (Ban Jelacic Square)
        const MAP_CENTER = [45.8131, 15.9775];
        const INITIAL_ZOOM = 14;
        const SURVEY_VERSION = "v1.0_Zagreb";

        const CONFIG = {
            minPointsToSubmit: 2,
            surveyVersion: SURVEY_VERSION
        };
        
        // --- APP STATE ---
        let map;
        let polyline = null;
        let points = [];
        let submitted = false;
        let submitting = false;
        let responsesLayer = null;
        let responsesVisible = false;
        let responsesLoading = false;
        let sheetUrl = SHEET_URL;

        // ============================================================
        // DOM ELEMENTS
        // ============================================================

        const elements = {
            map: document.getElementById('map'),
            welcomeModal: document.getElementById('welcome-modal'),
            btnCloseWelcome: document.getElementById('btn-close-welcome'),
            btnClear: document.getElementById('btn-clear'),
            btnSubmit: document.getElementById('btn-submit'),
            btnOpenSheet: document.getElementById('btn-open-sheet'),
            btnToggleResponses: document.getElementById('btn-toggle-responses'),
            status: document.getElementById('status'),
            overlay: document.getElementById('overlay'),
            pointCount: document.getElementById('point-count'),
            count: document.getElementById('count')
        };

        // ============================================================
        // INITIALIZATION
        // ============================================================

        function init() {
            if (!window.L || !window.L.map) {
                showMapError('Karta se nije učitala. Provjerite mrežu ili dopustite pristup unpkg.com.');
                return;
            }

            initMap();
            bindEvents();
            const alreadySubmitted = checkPreviousSubmission();
            if (!alreadySubmitted) {
                openWelcome();
            }
        }

        function initMap() {
            map = L.map('map', {
                center: MAP_CENTER,
                zoom: INITIAL_ZOOM,
                zoomControl: false,
                attributionControl: false,
                minZoom: 13, // Restrict so they can't zoom out to see all of Croatia
                maxZoom: 17
            });

            L.control.attribution({position: 'bottomright'}).addTo(map);

            map.createPane('responsesPane');
            map.getPane('responsesPane').style.zIndex = 200;

            // NEUTRAL BASEMAP (CartoDB Positron)
            // This is perfect for Zagreb as it shows street names clearly (Ilica, Vlaska, etc.)
            // but keeps the map grey so the user isn't biased by existing blue shapes.
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Lock boundaries to Zagreb area only
            // This prevents users from panning away to Samobor or Velika Gorica
            const bounds = map.getBounds().pad(0.5);
            map.setMaxBounds(bounds);
        }

        function bindEvents() {
            map.on('click', onMapClick);

            elements.btnClear.addEventListener('click', clearDrawing);
            elements.btnSubmit.addEventListener('click', submitDrawing);
            elements.btnOpenSheet.addEventListener('click', openSheet);
            elements.btnToggleResponses.addEventListener('click', toggleResponses);
            elements.btnCloseWelcome.addEventListener('click', closeWelcome);
            elements.welcomeModal.addEventListener('click', (event) => {
                if (event.target === elements.welcomeModal) {
                    closeWelcome();
                }
            });
        }

        function onMapClick(e) {
            if (submitted) return;
            addPoint(e.latlng);
        }

        // --- DRAWING LOGIC ---
        function addPoint(latlng) {
            points.push(latlng);
            if (polyline) {
                polyline.setLatLngs(points);
            } else {
                polyline = L.polyline(points, {
                    color: '#3388ff', // Standard blue for water
                    weight: 4,
                    opacity: 0.8,
                    smoothFactor: 1
                }).addTo(map);
            }
            updatePointCount();
            hideStatus();
        }

        function updatePointCount() {
            if (points.length > 0) {
                elements.pointCount.style.display = 'block';
                elements.count.textContent = points.length;
            } else {
                elements.pointCount.style.display = 'none';
            }
        }

        function clearDrawing() {
            if (submitted || submitting) return;

            points = [];
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            updatePointCount();
            hideStatus();
        }

        function openWelcome() {
            elements.welcomeModal.classList.remove('is-hidden');
        }

        function closeWelcome() {
            elements.welcomeModal.classList.add('is-hidden');
        }

        function openSheet() {
            if (!sheetUrl) {
                showStatus('Postavite SHEET_URL u index.html da biste otvorili tablicu.');
                return;
            }
            window.open(sheetUrl, '_blank', 'noopener');
        }

        function toggleResponses() {
            if (!map || responsesLoading) return;
            hideStatus();

            if (responsesLayer) {
                if (responsesVisible) {
                    map.removeLayer(responsesLayer);
                    responsesVisible = false;
                } else {
                    responsesLayer.addTo(map);
                    responsesVisible = true;
                }
                updateResponsesButton();
                return;
            }

            loadResponses();
        }

        function loadResponses() {
            responsesLoading = true;
            elements.btnToggleResponses.disabled = true;

            const callbackName = `loadResponses_${Date.now()}_${Math.floor(Math.random() * 100000)}`;
            const script = document.createElement('script');

            const cleanup = () => {
                responsesLoading = false;
                elements.btnToggleResponses.disabled = false;
                script.remove();
                delete window[callbackName];
            };

            window[callbackName] = (data) => {
                cleanup();

                if (!data || !Array.isArray(data.features) || data.features.length === 0) {
                    showStatus('Još nema odgovora.');
                    updateResponsesButton();
                    return;
                }

                if (data.metadata && data.metadata.sheet_url) {
                    sheetUrl = data.metadata.sheet_url;
                }

                responsesLayer = L.geoJSON(data, {
                    pane: 'responsesPane',
                    style: {
                        color: '#e67e22',
                        weight: 3,
                        opacity: 0.7
                    }
                });

                responsesLayer.addTo(map);
                responsesVisible = true;
                updateResponsesButton();
            };

            script.onerror = () => {
                cleanup();
                showStatus('Ne mogu učitati odgovore. Provjerite objavu Apps Scripta.');
            };

            const cacheBuster = Date.now();
            script.src = `${GOOGLE_SCRIPT_URL}?action=geojson&callback=${callbackName}&_=${cacheBuster}`;
            document.body.appendChild(script);
        }

        function updateResponsesButton() {
            if (responsesVisible) {
                elements.btnToggleResponses.classList.add('is-active');
                elements.btnToggleResponses.title = 'Sakrij odgovore';
                elements.btnToggleResponses.setAttribute('aria-label', 'Sakrij odgovore');
            } else {
                elements.btnToggleResponses.classList.remove('is-active');
                elements.btnToggleResponses.title = 'Prikaži odgovore';
                elements.btnToggleResponses.setAttribute('aria-label', 'Prikaži odgovore');
            }
        }

        // ============================================================
        // SUBMISSION LOGIC
        // ============================================================

        function sendPayload(payload) {
            const body = JSON.stringify(payload);

            if (navigator.sendBeacon) {
                try {
                    const blob = new Blob([body], { type: 'text/plain' });
                    const queued = navigator.sendBeacon(GOOGLE_SCRIPT_URL, blob);
                    if (queued) {
                        return Promise.resolve({ queued: true });
                    }
                } catch (error) {
                    // Fall through to fetch on any beacon errors.
                }
            }

            // Apps Script web apps do not emit CORS headers, so use no-cors.
            return fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body,
                mode: "no-cors",
                keepalive: true
            });
        }

        function submitDrawing() {
            if (submitted || submitting) return;

            // Validate minimum points
            if (points.length < CONFIG.minPointsToSubmit) {
                showStatus('Nacrtajte liniju s najmanje 2 točke.');
                return;
            }

            submitting = true;
            elements.btnSubmit.innerHTML = '<span class="spinner"></span>Šaljem';
            elements.btnSubmit.disabled = true;
            elements.btnClear.disabled = true;

            const geojson = polyline.toGeoJSON();

            const payload = {
                sessionId: generateSessionId(),
                timestamp: new Date().toISOString(),
                surveyVersion: CONFIG.surveyVersion,
                pointCount: points.length,
                geometry: geojson
            };

            sendPayload(payload)
                .then((response) => {
                    if (!response || response.type === 'opaque' || response.queued) {
                        onSubmitSuccess();
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Non-OK response');
                    }
                    onSubmitSuccess();
                })
                .catch((error) => {
                    console.error('Submission error:', error);
                    onSubmitError();
                });
        }

        function onSubmitSuccess() {
            submitted = true;
            submitting = false;

            // Mark as submitted in localStorage
            markAsSubmitted();

            // Show thank you overlay
            elements.overlay.style.display = 'flex';
            closeWelcome();
            elements.btnSubmit.innerHTML = 'Poslano';
            elements.btnSubmit.disabled = true;
            elements.btnClear.disabled = true;

            // Disable map interaction
            map.off('click', onMapClick);
            elements.map.style.cursor = 'default';
        }

        function onSubmitError() {
            submitting = false;
            elements.btnSubmit.innerHTML = 'Pošalji';
            elements.btnSubmit.disabled = false;
            elements.btnClear.disabled = false;
            showStatus('Greška pri slanju. Pokušajte ponovno.');
        }

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================

        function generateSessionId() {
            // Cryptographically random session ID
            const array = new Uint8Array(12);
            crypto.getRandomValues(array);
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }

        function showStatus(message) {
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }

        function hideStatus() {
            elements.status.style.display = 'none';
        }

        function showMapError(message) {
            elements.map.innerHTML = `<div class="map-error">${message}</div>`;
            elements.map.style.cursor = 'default';
            elements.btnSubmit.disabled = true;
            elements.btnClear.disabled = true;
            elements.btnOpenSheet.disabled = true;
            elements.btnToggleResponses.disabled = true;
        }

        // ============================================================
        // DUPLICATE SUBMISSION PREVENTION
        // ============================================================

        function markAsSubmitted() {
            try {
                localStorage.setItem('survey_submitted_' + CONFIG.surveyVersion, 'true');
            } catch (e) {
                // localStorage may be unavailable
            }
        }

        function checkPreviousSubmission() {
            let alreadySubmitted = false;
            try {
                if (localStorage.getItem('survey_submitted_' + CONFIG.surveyVersion) === 'true') {
                    submitted = true;
                    alreadySubmitted = true;
                    elements.overlay.style.display = 'flex';
                    elements.btnSubmit.innerHTML = 'Poslano';
                    elements.btnSubmit.disabled = true;
                    elements.btnClear.disabled = true;
                    map.off('click', onMapClick);
                    elements.map.style.cursor = 'default';
                    closeWelcome();
                }
            } catch (e) {
                // localStorage may be unavailable
            }
            return alreadySubmitted;
        }

        // ============================================================
        // START APPLICATION
        // ============================================================

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>

