<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Historical Watercourse Survey</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* RESET & LAYOUT */
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden; }
        
        /* MAP CONTAINER */
        #map { height: 100%; width: 100%; z-index: 1; cursor: crosshair; }

        /* UI OVERLAY */
        #ui-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            text-align: center;
            width: 90%;
            max-width: 400px;
            border: 1px solid #ddd;
        }

        /* TYPOGRAPHY */
        h1 { font-size: 16px; margin: 0 0 10px 0; color: #333; font-weight: 600; }
        p.instruction { font-size: 14px; color: #666; margin-bottom: 15px; line-height: 1.4; }

        /* BUTTONS */
        .btn-group { display: flex; gap: 10px; justify-content: center; }
        
        button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #btn-clear { background-color: #f1f1f1; color: #333; border: 1px solid #ccc; }
        #btn-submit { background-color: #2c3e50; color: white; }
        
        /* MODAL FOR SUCCESS */
        #success-modal {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white;
            z-index: 2000;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #3498db;
            border-radius: 50%; width: 20px; height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block; margin-right: 10px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="ui-container">
        <h1>Historical Watercourse Trace</h1>
        <p class="instruction">Tap on the map to trace the path where you believe the watercourse flowed.</p>
        <div class="btn-group">
            <button id="btn-clear">Clear Drawing</button>
            <button id="btn-submit">Submit Trace</button>
        </div>
        <div id="status-msg" style="margin-top:10px; font-size:12px; color:#e74c3c;"></div>
    </div>

    <div id="success-modal">
        <h2>Thank you.</h2>
        <p>Your submission has been recorded.</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THIS URL WITH YOUR GOOGLE APPS SCRIPT WEB APP URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxtzCgd8Wxj1A6I34Hwhny2m6h4PPPHCZyOQqNPQ7_zaJTXZkYouI0LDpDKAMaPEGaWMw/exec";
        
        const MAP_CENTER = [51.505, -0.09]; // CHANGE: City Center Lat/Lng
        const INITIAL_ZOOM = 14;            // CHANGE: Start Zoom
        const SURVEY_VERSION = "v1.0_London"; // Research identifier
        
        // --- APP STATE ---
        let map;
        let polyline = null;
        let points = [];
        let isSubmitted = false;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            setupEvents();
        });

        function initMap() {
            // Initialize Leaflet
            map = L.map('map', {
                center: MAP_CENTER,
                zoom: INITIAL_ZOOM,
                zoomControl: false, // Cleaner UI, can enable if strictly needed
                attributionControl: false,
                minZoom: INITIAL_ZOOM - 1,
                maxZoom: INITIAL_ZOOM + 2
            });

            // Add Attribution (Manual placement for minimalism if needed, or default)
            L.control.attribution({position: 'bottomright'}).addTo(map);

            // NEUTRAL BASEMAP (CartoDB Positron)
            // Excellent for research overlays as it is grayscale and unobtrusive.
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Lock boundaries (Optional: prevents user from panning too far away)
            const bounds = map.getBounds().pad(0.5); // Allow 50% buffer
            map.setMaxBounds(bounds);
        }

        function setupEvents() {
            // Map Click: Add Point
            map.on('click', (e) => {
                if (isSubmitted) return;
                addPoint(e.latlng);
            });

            // Buttons
            document.getElementById('btn-clear').addEventListener('click', clearDrawing);
            document.getElementById('btn-submit').addEventListener('click', submitData);
        }

        // --- DRAWING LOGIC ---
        function addPoint(latlng) {
            points.push(latlng);

            if (polyline) {
                // Update existing line
                polyline.setLatLngs(points);
            } else {
                // Create new line
                polyline = L.polyline(points, {
                    color: '#3388ff',
                    weight: 4,
                    opacity: 0.8,
                    smoothFactor: 1
                }).addTo(map);
            }
        }

        function clearDrawing() {
            if (isSubmitted) return;
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            points = [];
            document.getElementById('status-msg').innerText = "";
        }

        // --- SUBMISSION LOGIC ---
        function submitData() {
            if (isSubmitted) return;
            if (points.length < 2) {
                document.getElementById('status-msg').innerText = "Please draw a line (at least 2 points) before submitting.";
                return;
            }

            const btnSubmit = document.getElementById('btn-submit');
            btnSubmit.innerHTML = '<span class="spinner"></span>Sending...';
            btnSubmit.disabled = true;

            // Generate GeoJSON
            const geojson = polyline.toGeoJSON();

            // Prepare Payload
            const payload = {
                sessionId: generateSessionId(),
                version: SURVEY_VERSION,
                geo: geojson
            };

            // Send to Google Sheets
            // Using 'no-cors' mode is common for GAS, but here we use text/plain content type trick
            // to allow Simple Request which avoids preflight, ensuring we get data through.
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(payload)
            })
            .then(response => {
                // With GAS Web Apps, response is often opaque, but if it doesn't fail, we assume success for UX
                showThankYou();
            })
            .catch(error => {
                console.error('Error:', error);
                btnSubmit.innerText = "Error. Try again.";
                btnSubmit.disabled = false;
            });
        }

        function showThankYou() {
            isSubmitted = true;
            document.getElementById('success-modal').style.display = 'flex';
        }

        function generateSessionId() {
            return 'sess_' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>