<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zagreb Historical Watercourse Survey</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #fff;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 80px;
            z-index: 1;
            cursor: crosshair;
            background: #f5f5f5;
        }

        #map .map-error {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 16px;
            color: #444;
            font-size: 14px;
            background: #f5f5f5;
        }

        #controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 15px;
            z-index: 1000;
        }

        #instruction {
            font-size: 13px;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
        }

        .btn-row {
            display: flex;
            gap: 12px;
            width: 100%;
            max-width: 320px;
        }

        button {
            flex: 1;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: opacity 0.15s, background-color 0.15s;
        }

        button:active { opacity: 0.8; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }

        #btn-clear {
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
        }

        #btn-submit {
            background: #2c3e50;
            color: #fff;
        }

        #status {
            position: absolute;
            bottom: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: #e74c3c;
            color: #fff;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            z-index: 1001;
            display: none;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        #overlay h2 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        #overlay p {
            font-size: 14px;
            color: #666;
        }

        .leaflet-control-attribution {
            font-size: 10px !important;
        }

        /* Loading spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            display: inline-block;
            margin-right: 6px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Point count indicator */
        #point-count {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #555;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="point-count">Points: <span id="count">0</span></div>

    <div id="status"></div>

    <div id="controls">
        <p id="instruction">Draw a line on the map where you believe the watercourse flowed.</p>
        <div class="btn-row">
            <button id="btn-clear" type="button">Clear</button>
            <button id="btn-submit" type="button">Submit</button>
        </div>
    </div>

    <div id="overlay">
        <h2>Thank you</h2>
        <p>Your response has been recorded.</p>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // --- CONFIGURATION ---
        // REPLACE THIS WITH YOUR GOOGLE APPS SCRIPT URL
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxb68dmmMr2VBem50I7uj58hEfFOV3TMohDDWTtwhNKEA83pEznL7X6vItO7gwb4QsfJw/exec";
        
        // ZAGREB COORDINATES (Ban Jelacic Square)
        const MAP_CENTER = [45.8131, 15.9775];
        const INITIAL_ZOOM = 14;
        const SURVEY_VERSION = "v1.0_Zagreb";

        const CONFIG = {
            minPointsToSubmit: 2,
            surveyVersion: SURVEY_VERSION
        };
        
        // --- APP STATE ---
        let map;
        let polyline = null;
        let points = [];
        let submitted = false;
        let submitting = false;

        // ============================================================
        // DOM ELEMENTS
        // ============================================================

        const elements = {
            map: document.getElementById('map'),
            btnClear: document.getElementById('btn-clear'),
            btnSubmit: document.getElementById('btn-submit'),
            status: document.getElementById('status'),
            overlay: document.getElementById('overlay'),
            pointCount: document.getElementById('point-count'),
            count: document.getElementById('count')
        };

        // ============================================================
        // INITIALIZATION
        // ============================================================

        function init() {
            if (!window.L || !window.L.map) {
                showMapError('Map failed to load. Check your network or allow access to unpkg.com.');
                return;
            }

            initMap();
            bindEvents();
            checkPreviousSubmission();
        }

        function initMap() {
            map = L.map('map', {
                center: MAP_CENTER,
                zoom: INITIAL_ZOOM,
                zoomControl: false,
                attributionControl: false,
                minZoom: 13, // Restrict so they can't zoom out to see all of Croatia
                maxZoom: 17
            });

            L.control.attribution({position: 'bottomright'}).addTo(map);

            // NEUTRAL BASEMAP (CartoDB Positron)
            // This is perfect for Zagreb as it shows street names clearly (Ilica, Vlaska, etc.)
            // but keeps the map grey so the user isn't biased by existing blue shapes.
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Lock boundaries to Zagreb area only
            // This prevents users from panning away to Samobor or Velika Gorica
            const bounds = map.getBounds().pad(0.5);
            map.setMaxBounds(bounds);
        }

        function bindEvents() {
            map.on('click', onMapClick);

            elements.btnClear.addEventListener('click', clearDrawing);
            elements.btnSubmit.addEventListener('click', submitDrawing);
        }

        function onMapClick(e) {
            if (submitted) return;
            addPoint(e.latlng);
        }

        // --- DRAWING LOGIC ---
        function addPoint(latlng) {
            points.push(latlng);
            if (polyline) {
                polyline.setLatLngs(points);
            } else {
                polyline = L.polyline(points, {
                    color: '#3388ff', // Standard blue for water
                    weight: 4,
                    opacity: 0.8,
                    smoothFactor: 1
                }).addTo(map);
            }
            updatePointCount();
            hideStatus();
        }

        function updatePointCount() {
            if (points.length > 0) {
                elements.pointCount.style.display = 'block';
                elements.count.textContent = points.length;
            } else {
                elements.pointCount.style.display = 'none';
            }
        }

        function clearDrawing() {
            if (submitted || submitting) return;

            points = [];
            if (polyline) {
                map.removeLayer(polyline);
                polyline = null;
            }
            updatePointCount();
            hideStatus();
        }

        // ============================================================
        // SUBMISSION LOGIC
        // ============================================================

        function sendPayload(payload) {
            const body = JSON.stringify(payload);

            if (navigator.sendBeacon) {
                try {
                    const blob = new Blob([body], { type: 'text/plain' });
                    const queued = navigator.sendBeacon(GOOGLE_SCRIPT_URL, blob);
                    if (queued) {
                        return Promise.resolve({ queued: true });
                    }
                } catch (error) {
                    // Fall through to fetch on any beacon errors.
                }
            }

            // Apps Script web apps do not emit CORS headers, so use no-cors.
            return fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body,
                mode: "no-cors",
                keepalive: true
            });
        }

        function submitDrawing() {
            if (submitted || submitting) return;

            // Validate minimum points
            if (points.length < CONFIG.minPointsToSubmit) {
                showStatus('Please draw a line with at least 2 points.');
                return;
            }

            submitting = true;
            elements.btnSubmit.innerHTML = '<span class="spinner"></span>Sending';
            elements.btnSubmit.disabled = true;
            elements.btnClear.disabled = true;

            const geojson = polyline.toGeoJSON();

            const payload = {
                sessionId: generateSessionId(),
                timestamp: new Date().toISOString(),
                surveyVersion: CONFIG.surveyVersion,
                pointCount: points.length,
                geometry: geojson
            };

            sendPayload(payload)
                .then((response) => {
                    if (!response || response.type === 'opaque' || response.queued) {
                        onSubmitSuccess();
                        return;
                    }
                    if (!response.ok) {
                        throw new Error('Non-OK response');
                    }
                    onSubmitSuccess();
                })
                .catch((error) => {
                    console.error('Submission error:', error);
                    onSubmitError();
                });
        }

        function onSubmitSuccess() {
            submitted = true;
            submitting = false;

            // Mark as submitted in localStorage
            markAsSubmitted();

            // Show thank you overlay
            elements.overlay.style.display = 'flex';
            elements.btnSubmit.innerHTML = 'Submitted';
            elements.btnSubmit.disabled = true;
            elements.btnClear.disabled = true;

            // Disable map interaction
            map.off('click', onMapClick);
            elements.map.style.cursor = 'default';
        }

        function onSubmitError() {
            submitting = false;
            elements.btnSubmit.innerHTML = 'Submit';
            elements.btnSubmit.disabled = false;
            elements.btnClear.disabled = false;
            showStatus('Error sending. Please try again.');
        }

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================

        function generateSessionId() {
            // Cryptographically random session ID
            const array = new Uint8Array(12);
            crypto.getRandomValues(array);
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }

        function showStatus(message) {
            elements.status.textContent = message;
            elements.status.style.display = 'block';
        }

        function hideStatus() {
            elements.status.style.display = 'none';
        }

        function showMapError(message) {
            elements.map.innerHTML = `<div class="map-error">${message}</div>`;
            elements.map.style.cursor = 'default';
            elements.btnSubmit.disabled = true;
            elements.btnClear.disabled = true;
        }

        // ============================================================
        // DUPLICATE SUBMISSION PREVENTION
        // ============================================================

        function markAsSubmitted() {
            try {
                localStorage.setItem('survey_submitted_' + CONFIG.surveyVersion, 'true');
            } catch (e) {
                // localStorage may be unavailable
            }
        }

        function checkPreviousSubmission() {
            try {
                if (localStorage.getItem('survey_submitted_' + CONFIG.surveyVersion) === 'true') {
                    submitted = true;
                    elements.overlay.style.display = 'flex';
                    elements.btnSubmit.innerHTML = 'Submitted';
                    elements.btnSubmit.disabled = true;
                    elements.btnClear.disabled = true;
                    map.off('click', onMapClick);
                    elements.map.style.cursor = 'default';
                }
            } catch (e) {
                // localStorage may be unavailable
            }
        }

        // ============================================================
        // START APPLICATION
        // ============================================================

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
